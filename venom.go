package venom

import (
	"log"
	"time"

	"github.com/spf13/cobra"
)

// Initialize a new documentation command with cmd as the parent, providing options for customization
// The provided command will always provide documentation from the *root*, which allows the caller to list this automated
// command under other administrative/tooling/hidden commands as needed.
func Initialize(cmd *cobra.Command, options *Options) error {
	if options == nil {
		options = NewOptions()
	}

	logger := options.logger
	if logger == nil {
		logger = log.Default()
	}

	if err := options.validate(); err != nil {
		return err
	}

	cmd.AddCommand(&cobra.Command{
		Use:    options.commandName,
		Hidden: true,
		RunE: func(cmd *cobra.Command, args []string) error {
			root := cmd.Root()
			root.InitDefaultHelpCmd()
			root.InitDefaultHelpFlag()

			documentation := Documentation{
				GenerationDate: time.Now().Format("2-Jan-2006"),
				RootCommand:    NewCommandFromCobra(root),
			}

			if !cmd.DisableAutoGenTag {
				documentation.AutoGenerationTag = "Auto-generated by jimschubert/venom"
			}

			// TODO: output, wire up functions, template

			return nil
		},
	})

	return nil
}
